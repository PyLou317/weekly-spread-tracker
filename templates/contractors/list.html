{% extends 'base.html' %}
{% load humanize %}

{% block title %}Contractors - Staffing Tracker{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    <div class="card rounded-4 shadow p-4 mb-4">
        <div class="d-flex align-items-center justify-content-between mb-4">
    <div>
                <h2 class="fw-bold mb-1">Contractors</h2>
                <div class="text-muted">Manage your contractor list and details here.</div>
            </div>
            <div class="candidates-header-actions">
                <a href="{% url 'contractors:review_queue' %}" class="btn btn-warning rounded-pill me-2">
            <i class="fas fa-clock"></i> Review Queue
        </a>
                <a href="{% url 'contractors:create' %}" class="btn btn-primary rounded-pill">
                                <i class="fas fa-plus"></i> Add Contractor
        </a>
                <a href="{% url 'reports:upload' %}" class="btn btn-secondary ms-2 rounded-pill">
                    <i class="fas fa-upload"></i> Upload Report
                </a>
    </div>
</div>

        <!-- Search & Filters -->
        <form method="get" class="modern-search-bar mb-4">
            <div class="search-bar-inner">
                <input type="text" name="search" class="form-control search-input" placeholder="Search by contractor or client name..." value="{{ search|default_if_none:'' }}">
                <button type="submit" class="btn search-bar-btn">Search</button>
            </div>
        </form>

        <div class="table-responsive">
            <table class="table align-middle mb-0 table-container">
                <thead>
                    <tr>
                        <th class="mobile-only">
                            <a href="?sort=contractor_name&direction={% if sort == 'contractor_name' and direction == 'asc' %}desc{% else %}asc{% endif %}{% if search %}&search={{ search }}{% endif %}" class="fw-semibold d-inline-flex align-items-center {% if sort == 'contractor_name' %}table-sort-active{% endif %}">
                                Name
                                {% if sort == 'contractor_name' %}
                                    {% if direction == 'asc' %}
                                        <i class="fas fa-chevron-up ms-1"></i>
                                    {% else %}
                                        <i class="fas fa-chevron-down ms-1"></i>
                                    {% endif %}
                                {% else %}
                                    <i class="fas fa-chevron-up ms-1 text-muted opacity-25"></i>
                                {% endif %}
                            </a>
                        </th>
                        <th class="desktop-only">
                            <a href="?sort=contractor_name&direction={% if sort == 'contractor_name' and direction == 'asc' %}desc{% else %}asc{% endif %}{% if search %}&search={{ search }}{% endif %}" class="fw-semibold d-inline-flex align-items-center {% if sort == 'contractor_name' %}table-sort-active{% endif %}">
                                Contractor Name
                                {% if sort == 'contractor_name' %}
                                    {% if direction == 'asc' %}
                                        <i class="fas fa-chevron-up ms-1"></i>
                                    {% else %}
                                        <i class="fas fa-chevron-down ms-1"></i>
                                    {% endif %}
                                {% else %}
                                    <i class="fas fa-chevron-up ms-1 text-muted opacity-25"></i>
                                {% endif %}
                            </a>
                        </th>
                        <th class="desktop-only">
                            <a href="?sort=client_name&direction={% if sort == 'client_name' and direction == 'asc' %}desc{% else %}asc{% endif %}{% if search %}&search={{ search }}{% endif %}" class="fw-semibold d-inline-flex align-items-center {% if sort == 'client_name' %}table-sort-active{% endif %}">
                                Client Name
                                {% if sort == 'client_name' %}
                                    {% if direction == 'asc' %}
                                        <i class="fas fa-chevron-up ms-1"></i>
                                    {% else %}
                                        <i class="fas fa-chevron-down ms-1"></i>
                                    {% endif %}
                                {% else %}
                                    <i class="fas fa-chevron-up ms-1 text-muted opacity-25"></i>
                                {% endif %}
                            </a>
                        </th>
                        <th class="desktop-only">
                            <a href="?sort=contract_start_date&direction={% if sort == 'contract_start_date' and direction == 'asc' %}desc{% else %}asc{% endif %}{% if search %}&search={{ search }}{% endif %}" class="fw-semibold d-inline-flex align-items-center {% if sort == 'contract_start_date' %}table-sort-active{% endif %}">
                                Start Date
                                {% if sort == 'contract_start_date' %}
                                    {% if direction == 'asc' %}
                                        <i class="fas fa-chevron-up ms-1"></i>
                                    {% else %}
                                        <i class="fas fa-chevron-down ms-1"></i>
                                    {% endif %}
                                {% else %}
                                    <i class="fas fa-chevron-up ms-1 text-light opacity-25"></i>
                                {% endif %}
                            </a>
                        </th>
                        <th class="desktop-only">
                            <a href="?sort=contract_end_date&direction={% if sort == 'contract_end_date' and direction == 'asc' %}desc{% else %}asc{% endif %}{% if search %}&search={{ search }}{% endif %}" class="fw-semibold d-inline-flex align-items-center {% if sort == 'contract_end_date' %}table-sort-active{% endif %}">
                                End Date
                                {% if sort == 'contract_end_date' %}
                                    {% if direction == 'asc' %}
                                        <i class="fas fa-chevron-up ms-1"></i>
                                    {% else %}
                                        <i class="fas fa-chevron-down ms-1"></i>
                                    {% endif %}
                                {% else %}
                                    <i class="fas fa-chevron-up ms-1 text-light opacity-25"></i>
                                {% endif %}
                            </a>
                        </th>
                        <th class="desktop-only">
                            <a href="?sort=recruiter_or_account_manager&direction={% if sort == 'recruiter_or_account_manager' and direction == 'asc' %}desc{% else %}asc{% endif %}{% if search %}&search={{ search }}{% endif %}" class="fw-semibold d-inline-flex align-items-center {% if sort == 'recruiter_or_account_manager' %}table-sort-active{% endif %}">
                                {% if user_profile and user_profile.role == 'account_manager' %}
                                    Recruiter
                                {% elif user_profile and user_profile.role == 'recruiter' %}
                                    Account Manager
                                {% else %}
                                    Recruiter/Account Manager
                                {% endif %}
                                {% if sort == 'recruiter_or_account_manager' %}
                                    {% if direction == 'asc' %}
                                        <i class="fas fa-chevron-up ms-1"></i>
                                    {% else %}
                                        <i class="fas fa-chevron-down ms-1"></i>
                                    {% endif %}
                                {% else %}
                                    <i class="fas fa-chevron-up ms-1 text-muted opacity-25"></i>
                                {% endif %}
                            </a>
                        </th>
                        <th class="desktop-only">
                            <a href="?sort=status&direction={% if sort == 'status' and direction == 'asc' %}desc{% else %}asc{% endif %}{% if search %}&search={{ search }}{% endif %}" class="fw-semibold d-inline-flex align-items-center {% if sort == 'status' %}table-sort-active{% endif %}">
                                Status
                                {% if sort == 'status' %}
                                    {% if direction == 'asc' %}
                                        <i class="fas fa-chevron-up ms-1"></i>
                                    {% else %}
                                        <i class="fas fa-chevron-down ms-1"></i>
                                    {% endif %}
                                {% else %}
                                    <i class="fas fa-chevron-up ms-1 text-muted opacity-25"></i>
                                {% endif %}
                            </a>
                        </th>
                        <th>
                            <a href="?sort=weekly_spread_amount&direction={% if sort == 'weekly_spread_amount' and direction == 'asc' %}desc{% else %}asc{% endif %}{% if search %}&search={{ search }}{% endif %}" class="fw-semibold d-inline-flex align-items-center {% if sort == 'weekly_spread_amount' %}table-sort-active{% endif %}">
                                Spread
                                {% if sort == 'weekly_spread_amount' %}
                                    {% if direction == 'asc' %}
                                        <i class="fas fa-chevron-up ms-1"></i>
                                    {% else %}
                                        <i class="fas fa-chevron-down ms-1"></i>
                                    {% endif %}
                                {% else %}
                                    <i class="fas fa-chevron-up ms-1 text-muted opacity-25"></i>
                                {% endif %}
                            </a>
                        </th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for candidate in page_obj %}
                    <tr class="table-row-hover">
                        <td class="mobile-only">
                            <div class="fw-semibold small">{{ candidate.contractor_name }}</div>
                            <div class="text-muted small">{{ candidate.client_name }}</div>
                        </td>
                        <td class="fw-semibold small desktop-only">{{ candidate.contractor_name }}</td>
                        <td class="small desktop-only">{{ candidate.client_name }}</td>
                        <td class="desktop-only">
                            <span class="small">{{ candidate.contract_start_date|date:'d/m/Y' }}</span>
                        </td>
                        <td class="desktop-only">
                            <span class="small">{{ candidate.contract_end_date|date:'d/m/Y' }}</span>
                        </td>
                        <td class="desktop-only">{{ candidate.recruiter_or_account_manager }}</td>
                        <td class="desktop-only">
                            {% if candidate.status == 'active' %}
                                <span class="badge rounded-pill bg-success-subtle badge-active">Active</span>
                            {% elif candidate.status == 'review' %}
                                <span class="badge rounded-pill bg-warning-subtle text-warning">For Review</span>
                            {% elif candidate.status == 'inactive' %}
                                <span class="badge rounded-pill bg-secondary-subtle text-secondary">Inactive</span>
                            {% else %}
                                <span class="badge rounded-pill bg-light text-dark">{{ candidate.status }}</span>
                            {% endif %}
                        </td>
                        <td class="fw-semibold">${{ candidate.weekly_spread_amount|floatformat:2|intcomma }}</td>
                        <td class="text-end position-relative">
                            <button class="btn btn-light btn-circle action-menu-toggle" type="button" title="Actions">
                                <i class="fas fa-ellipsis-h"></i>
                            </button>
                            <div class="action-menu-dropdown d-none">
                                <a href="{% url 'contractors:edit' candidate.pk %}" class="dropdown-item">
                                    <i class="fas fa-edit me-2"></i> Edit
                                </a>
                                <form method="post" action="{% url 'contractors:delete' candidate.pk %}" class="inline-form">
                                    {% csrf_token %}
                                    <button type="submit" class="dropdown-item text-danger" onclick="return confirm('Are you sure you want to delete this contractor?');">
                                        <i class="fas fa-trash me-2"></i> Delete
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        {% if page_obj.has_other_pages %}
        <div class="d-flex justify-content-between align-items-center mt-4">
            <div class="text-muted small">Total {{ page_obj.paginator.count }}</div>
        <nav>
                <ul class="pagination pagination-rounded mb-0">
                {% if page_obj.has_previous %}
                    <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if search %}&search={{ search }}{% endif %}">&laquo;</a>
                    </li>
                {% endif %}
                {% for num in page_obj.paginator.page_range %}
                    {% if page_obj.number == num %}
                            <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                            <li class="page-item"><a class="page-link" href="?page={{ num }}{% if search %}&search={{ search }}{% endif %}">{{ num }}</a></li>
                        {% endif %}
                    {% endfor %}
                    {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if search %}&search={{ search }}{% endif %}">&raquo;</a>
                    </li>
                {% endif %}
            </ul>
        </nav>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

<style>
/* Base styles - hide desktop by default */
.desktop-only {
    display: none !important;
}

.mobile-only {
    display: table-cell !important;
}

/* Tablet and larger - show desktop, hide mobile */
@media (min-width: 768px) {
    .desktop-only {
        display: table-cell !important;
    }
    
    .mobile-only {
        display: none !important;
    }
}

/* Ensure proper table display */
.table td, .table th {
    display: table-cell;
}
</style>